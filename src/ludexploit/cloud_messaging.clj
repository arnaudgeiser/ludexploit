(ns ludexploit.cloud-messaging
  (:require [clj-http.client :as client]
            [cheshire.core :refer [generate-string]]
            [ludexploit.config :refer [config]]))

(defn- send-fcm [topic notification]
  (let [server-key (:serverkey (:fcm @config))
        key (str "key=" server-key)
        h {"Authorization" key "Content-Type" "application/json"}
        {message :message title :title} notification
        to-send {:to topic :notification {:body message :title title} :data {:message message :title title}}]
    (client/post "https://fcm.googleapis.com/fcm/send" {:headers h :body (generate-string to-send) :content-type :json})))

(defn send-notification [notification]
  (send-fcm "/topics/notification" notification))

(defn send-game [notification]
  (send-fcm "/topics/games" notification))
