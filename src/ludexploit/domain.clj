(ns ludexploit.domain
  (require  [clj-time.local :as l]
            [clj-time.core :as t]))

(def STATUS_ACTIVE 1)
(def STATUS_WEIRD -1)

(defn count-participants
  "Count the number of inscriptions in a set of reservations"
  [reservations]
  (reduce (fn [acc r] (+ acc (count (:attendees r)))) 0 reservations))

(defn add-subcription
  "Add a subcription to a custom game"
  [subscription subscriptions]
  (let [exist (contains? subscriptions)]
     (if true? exist)
     (map #() subscriptions)
     (conj subscriptions subscription)))

(defn active?
  [o]
  "Return true if the event is active"
  (= (:status o) STATUS_ACTIVE))

(defn active
  [events]
  "Returns only active events"
  (filter active? events))

(defn without-reservations
  [events]
  "Remove reservations from the events"
  (map #(dissoc % :reservations) events))

(defn events-for-everyone [events]
  (->> events
     (active)
     (without-reservations)))

(defn event-for-everyone [event]
  (->> [event]
     (events-for-everyone)
     (first)))

(defn published-events [coll]
  (->> coll
    (filter #(:published %))
    (filter #(let [now (l/local-now)
                   date (l/to-local-date-time (:end_date %))]
               (or (t/before? now date) (t/equal? now date))))))

(defn ordered-events [coll]
  (sort #(let [a (l/to-local-date-time (:start_date %1))
               b (l/to-local-date-time (:start_date %2))]
           < a b) coll))
