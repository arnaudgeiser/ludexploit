(ns ludexploit-cj.handler
  (:require [compojure.core :refer :all]
            [compojure.route :as route]
            [clojure.java.io :refer :all]
            [clojure.set :refer :all]
            [ring.middleware.json :refer [wrap-json-body wrap-json-response]]
            [ring.middleware.basic-authentication :refer [wrap-basic-authentication]]
            [ring.middleware.cors :refer [wrap-cors]]
            [ludexploit-cj.printing :as p]
            [ludexploit-cj.data-access :refer :all]
            [ludexploit-cj.email :as email]
            [ludexploit-cj.config :refer :all]
            [cheshire.generate :refer [add-encoder]]
            [cheshire.core :refer [generate-string]]
            [ring.middleware.defaults :refer [wrap-defaults site-defaults api-defaults]]
            [clj-time.core :as t]
            [clj-time.format :as f]
            [clj-time.coerce :as c]
            [clj-http.client :as client]
            [crypto.password.bcrypt :refer [encrypt check]])
    (:import [ch.waterbead PasswordHasher]))

(def date-formatter
  (f/formatter "dd-MM-yyyy"))

(defn to-sql-date [date] (c/to-sql-date (f/parse date-formatter date)))

(add-encoder org.joda.time.DateTime
    (fn [c jsonGenerator]
      (.writeString jsonGenerator (str c))))

(defn filter-inscriptions [events]
  (filter #(and (:hasinscriptions %) (< (:ticket_spaces %) 100)) events))

  (defn emails-from-event [event]
    (for [r (:reservations event)
    :let [address (:user_email r)]
    :when (not (nil? address))]
      address))

(defn emails [events]
  (flatten (map #(emails-from-event %) events)))

(defn send-message [req]
  (let [idEvent (get-in req [:route-params :idEvent])
        email (:body req)
        event (search-event idEvent)
        adresses (emails event)
        email-to-send (assoc email :to adresses)]
          (if (seq? adresses) (do (email/send-message email-to-send) event))))

(defn create-and-get-reservation [req]
  (let [data (assoc (:body req) :event_id (get-in req [:route-params :idEvent]))]
    (do
      (create-reservation data)
      (search-event (:event_id data)))))

(defn search-events-by-day [events day]
  (for [e events
        :let [start-date (c/from-sql-date (:event_start_date e))]
        :when (= (t/day-of-week start-date) (Integer/parseInt day))]
        e))

(defn authenticated? [name pass]
  (let [users (:users config)
        password (get users name)]
  (if (nil? password) false (check pass password))))

  (defn is-match? [password user]
    (let [hasher (PasswordHasher. 8)]
      (.CheckPassword hasher password (:user_pass user))))

(defn user-authenticated? [name pass]
  (let [db-user (search-user name)]
  (try
    (is-match? pass db-user)
    (catch Exception e false))))

(defn login [{name :username pass :password}]
  (let [db-user (search-user name)]
  (if (is-match? pass db-user) (select-keys db-user [:id]) {})))

(defn send-notification [notification]
  (let [server-key (:serverkey (:fcm @config))
        key (str "key=" server-key)
        h {"Authorization" key "Content-Type" "application/json"}
        {message :message title :title} notification
        to-send {:to "/topics/notification" :notification {:body message :title title} :data {:message message :title title}}]
    (client/post "https://fcm.googleapis.com/fcm/send" {:headers h :body (generate-string to-send) :content-type :json})))

(defroutes app-routes
  (POST "/login" [] (generate-string true))
  (GET "/festivals/:idFestival/events" [idFestival] (sort-by :event_name (search-events-by-festival idFestival)))
  (GET "/events/:idEvent" [idEvent] (search-event idEvent))
  (GET "/events/:idEvent/emails" [idEvent] (emails (search-event idEvent)))
  (PUT "/events/:idEvent/send" req (generate-string (first (send-message req))))
  (GET "/events/:idEvent/raw" [idEvent] (generate-string (search-event-raw idEvent)))
  (POST "/events/:idEvent/reservations" req (generate-string (create-and-get-reservation req)))
  (DELETE "/reservations/:idReservation" [idReservation] (do (delete-reservation idReservation)) {})
  (POST "/notifications/send" req (generate-string (send-notification (:body req))))
  (POST "/reservations" req (create-reservation (:body req)))
  (route/not-found "Not Found"))

(defroutes util-routes
  (GET "/festivals" [] (search-festivals))
  (GET "/encrypt/:password" [password] (encrypt password))
  (GET "/events/:idEvent/print" [idEvent] (p/print-programme [(search-event idEvent)]))
  (GET "/festivals/:idFestival/print" [idFestival] {:headers {"Content-Type" "application/pdf"} :body (p/print-programme (filter-inscriptions (search-events-by-festival idFestival)))})
  (GET "/festivals/bydate/:date/print" [date] {:headers {"Content-Type" "application/pdf"} :body (p/print-programme (filter-inscriptions (search-events-by-date (to-sql-date date))))})
  (GET "/festivals/:idFestival/byday/:day/print" [idFestival day] {:headers {"Content-Type" "application/pdf"} :body (p/print-programme (filter-inscriptions (search-events-by-day (search-events-by-festival idFestival) day)))})
  (GET "/festivals/:idFestival/byday/:day" [idFestival day] (generate-string (search-events-by-day (search-events-by-festival idFestival) day))))

; Public routes for users API
(defroutes public-routes
  (GET "/public/festivals/:idFestival/events" [idFestival] (map #(dissoc % :reservations) (search-events-by-festival idFestival)))
  (GET "/public/events/:idEvent" [idEvent] (generate-string (search-event idEvent)))
  (GET "/public/places" [] (search-places))
  (GET "/public/categories" [] (categories))
  (GET "/public/festivals/:idFestival/users/:idUser/reservations" [idFestival idUser] (search-events-by-festival-user idFestival idUser))
  (GET "/public/games" [] (search-games))
  (POST "/public/games/:id" [id name] (subscribe-to-game-as name))
  (POST "/public/games" req (do (prn (:body req))(create-game (:body req))))
  (GET "/public/secured/users/:id/reservations" [id] (search-reservations id))
  (POST "/public/secured/login" req (generate-string (login (:body req)))))

(defn wrap-override-cors [routes]
  (wrap-cors routes :access-control-allow-origin [#".*"] :access-control-allow-methods [:get :put :post :delete] :access-control-allow-credentials "true"))

(defroutes app
  (ANY "*" [] (-> util-routes
    (wrap-defaults (assoc-in site-defaults [:security :anti-forgery] false))
    (wrap-override-cors)
    (wrap-json-response)))
  (ANY "/public/secured/*" [] (-> public-routes
    (wrap-defaults (assoc-in site-defaults [:security :anti-forgery] false))
    (wrap-override-cors)
    (wrap-json-response)
    (wrap-json-body {:keywords? true})
    (wrap-basic-authentication user-authenticated? nil {:body "Aurelie non plus"})))
  (ANY "/public/*" [] (-> public-routes
    (wrap-override-cors)
    (wrap-json-body {:keywords? true})
    (wrap-json-response)))
  (ANY "*" [] (-> app-routes
    (wrap-defaults (assoc-in site-defaults [:security :anti-forgery] false))
    (wrap-json-body {:keywords? true})
    (wrap-json-response)
    ;(wrap-basic-authentication authenticated? nil {:body "Arnaud est pas dac"})
    (wrap-override-cors))))
