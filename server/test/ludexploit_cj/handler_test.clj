(ns ludexploit-cj.handler-test
  (:require [clojure.test :refer :all]
            [ring.mock.request :as mock]
            [ludexploit-cj.data-access :refer :all]
            [ludexploit-cj.handler :refer :all]))

(def data-meta {"attendees" {"168" [{"attendee_name" "Rosselet Fiona"}]} "booking" {"owner" "" "dbem_newsletter" ""} "registration" {"user_name" "Geiser Arnaud" "user_email" "" "dbem_phone" "0797246936" "user_newsletter" "0"}})
(def data-event {:event_start_date #inst "2016-03-10T23:00:00.000-00:00", :booking_tax_rate 0.0000M, :blog_id nil, :event_rsvp_time #inst "1969-12-31T23:00:00.000-00:00", :user_activation_key "$P$B/yvlv3P84xpF5q25EzWI9Imhm494h/", :user_pass "$P$B4gPveqpIilRq45jxEiSpRF7fgnMpp.", :ticket_price 0.0000M, :recurrence_id nil, :booking_price 0.0000M, :meta_key "festival_id", :event_category_id nil, :meta_id 9922, :ticket_meta nil, :booking_taxes 0.0000M, :recurrence_byday nil, :ticket_spaces 60, :event_id_3 169, :location_id 11, :meta_value "2490", :user_registered #inst "2015-01-28T11:18:42.000000000-00:00", :person_id 30, :user_email "fionalaura.rosselet-jordan@unifr.ch", :recurrence_days 0, :event_status 1, :ticket_end #inst "2016-03-11T23:00:00.000000000-00:00", :event_id 169, :post_id_2 2621, :event_end_date #inst "2016-03-11T23:00:00.000-00:00", :event_rsvp_spaces 0, :ticket_name "Billet Standard", :recurrence_byweekno nil, :event_id_4 169, :user_login "fionalaura.rosselet-jordan", :event_date_modified #inst "2016-01-19T21:02:27.000000000-00:00", :ticket_members_roles nil, :group_id 0, :post_id 2621, :event_attributes "a:8:{s:11:\"festival_id\";s:4:\"2490\";s:16:\"inscription_mode\";s:1:\"1\";s:11:\"Type de jeu\";s:0:\"\";s:3:\"Age\";s:0:\"\";s:6:\"Niveau\";s:0:\"\";s:13:\"Theme/Univers\";s:0:\"\";s:30:\"Remarque pour les responsables\";s:0:\"\";s:14:\"Type de partie\";s:0:\"\";}", :event_end_time #inst "1970-01-01T01:00:00.000-00:00", :event_slug "ludesco-2016-25", :event_private false, :id 30, :event_rsvp_date #inst "2016-03-11T23:00:00.000-00:00", :ticket_max nil, :booking_id 435, :recurrence false, :ticket_id 168, :ticket_members nil, :ticket_start nil, :event_date_created #inst "2016-01-10T11:29:12.000000000-00:00", :ticket_min nil, :recurrence_freq nil, :recurrence_interval nil, :booking_meta "a:3:{s:9:\"attendees\";a:1:{i:168;a:1:{i:0;a:1:{s:13:\"attendee_name\";s:14:\"Rosselet Fiona\";}}}s:7:\"booking\";a:2:{s:5:\"owner\";s:0:\"\";s:15:\"dbem_newsletter\";s:0:\"\";}s:12:\"registration\";a:4:{s:9:\"user_name\";s:13:\"Geiser Arnaud\";s:10:\"user_email\";s:0:\"\";s:10:\"dbem_phone\";s:10:\"0797246936\";s:15:\"user_newsletter\";s:1:\"0\";}}", :user_nicename "fionalaura-rosselet-jordan", :booking_status true, :event_spaces 0, :booking_spaces 1, :event_all_day 0, :display_name "Rosselet Fiona", :event_rsvp true, :event_start_time #inst "1970-01-01T22:59:00.000-00:00", :recurrence_rsvp_days nil, :event_owner 271, :ticket_guests nil, :booking_comment "", :event_name "Les Loups-Garous de Ludesco - Partie géante 3 villages", :booking_date #inst "2016-01-20T11:23:32.000000000-00:00", :user_url "", :ticket_description nil, :post_content "<p class=\"western\" lang=\"zxx\"><span style=\"font-family: Arial, sans-serif;\"><span style=\"font-size: small;\"><span lang=\"fr-CH\">Depuis la première édition, la partie de Loups-Garous à trois villages fait partie des moments incontournables de Ludesco… En deux mots, Les Loups-Garous de Thiercelieux est un jeu d’ambiance où chaque joueur incarne soit un loup-garou, soit un villageois. Le but des villageois est de démasquer les Loups-Garous présents parmi eux. Un jeu qui sent bon le bluff et la discussion et où le sang et les rires coulent à profusion ! Une partie d’</span></span></span><span style=\"font-family: Arial, sans-serif;\"><span style=\"font-size: small;\"><span lang=\"fr-CH\">initiation</span></span></span><span style=\"font-family: Arial, sans-serif;\"><span style=\"font-size: small;\"><span lang=\"fr-CH\"> est prévue à </span></span></span><span style=\"font-family: Arial, sans-serif;\"><span style=\"font-size: small;\"><span lang=\"fr-CH\">23h00 sur la Galerie </span></span></span><span style=\"font-family: Arial, sans-serif;\"><span style=\"font-size: small;\"><span lang=\"fr-CH\">pour les joueurs ne connaissant pas les règles de base, la maîtrise de celles-ci étant </span></span></span><span style=\"font-family: Arial, sans-serif;\"><span style=\"font-size: small;\"><span lang=\"fr-CH\"><u>indispensable</u></span></span></span><span style=\"font-family: Arial, sans-serif;\"><span style=\"font-size: small;\"><span lang=\"fr-CH\"> pour s’inscrire à la partie géante.</span></span></span></p>", :user_status 0, :event_id_2 169, :ticket_required nil})


(deftest test-app
  (testing "Transform event from database into the domain event"
    (is (= '("Rosselet Fiona") (booking-meta-to-attendees data-meta)))
    (is (= '("Rosselet Fiona") (:attendees (first (readable-events (cons data-event []))))))
    (is (= "Geiser Arnaud" (:username (first (readable-events (cons data-event []))))))
    (is (= "Geiser Arnaud" (booking-meta-to-username data-meta)))
    (is (= '("Geiser Arnaud",("Rosselet Fiona")) (vals (select-keys (booking-meta-to-data data-meta) [:username :attendees]))))
 ))
